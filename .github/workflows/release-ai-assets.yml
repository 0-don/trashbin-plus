name: Release AI Assets

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "ai-converter/**"
      - ".github/workflows/release-ai-assets.yml"

concurrency:
  group: ai-assets-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: "ai-converter/pyproject.toml"

      - name: Install converter dependencies
        working-directory: ai-converter
        run: uv sync

      - name: Convert SONICS model to ONNX
        working-directory: ai-converter
        run: |
          mkdir -p ../ai-assets
          uv run python convert_to_onnx.py --output_path ../ai-assets/sonics_model.onnx

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2

      - name: Collect WASM files from onnxruntime-web
        run: |
          mkdir -p /tmp/ort && cd /tmp/ort
          bun init -y
          bun add onnxruntime-web@1.24.1
          cp node_modules/onnxruntime-web/dist/ort-wasm-simd-threaded.wasm $GITHUB_WORKSPACE/ai-assets/

      - name: Create version file
        run: |
          echo "{\"version\":\"${{ github.sha }}\",\"date\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > ai-assets/version.json

      - name: Upload to HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface_hub
          python -c "
          from huggingface_hub import HfApi
          api = HfApi()
          api.upload_folder(
              folder_path='ai-assets',
              repo_id='0don/trashbin-plus-ai',
              repo_type='model',
              commit_message='Update AI assets (${{ github.sha }})',
          )
          "
