name: Release AI Assets

on:
  workflow_dispatch:
  push:
    branches: [main]

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: "ai-converter/pyproject.toml"

      - name: Install converter dependencies
        working-directory: ai-converter
        run: uv sync

      - name: Convert SONICS model to ONNX
        working-directory: ai-converter
        run: uv run python convert_to_onnx.py --output_path ../sonics_model.onnx

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2

      - name: Collect WASM files from onnxruntime-web
        run: |
          mkdir -p /tmp/ort && cd /tmp/ort
          bun init -y
          bun add onnxruntime-web@1.24.1
          mkdir -p $GITHUB_WORKSPACE/ai-assets
          cp node_modules/onnxruntime-web/dist/ort-wasm-simd-threaded.wasm $GITHUB_WORKSPACE/ai-assets/

      - name: Prepare release assets
        run: |
          mv sonics_model.onnx ai-assets/
          echo "{\"version\":\"${{ github.sha }}\",\"date\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > ai-assets/version.json

      - name: Create or update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ai-assets \
            --title "AI Detection Assets" \
            --notes "ONNX model and WebAssembly files for AI song detection" \
            --latest=false \
            2>/dev/null || true
          gh release upload ai-assets ai-assets/* --clobber
